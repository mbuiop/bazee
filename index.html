<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø·Ø§Ø± Ø¬Ù†Ú¯ÛŒ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ - Train Combat Simulator</title>
    
    <!-- Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
</head>
<body>
    <div id="gameContainer">
        <!-- ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
        <div id="loadingScreen">
            <div class="title">ğŸš‚ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            <div class="loading-text" id="loadingText">Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ</div>
            <div class="loading-bar">
                <div class="loading-progress" id="loadingProgress"></div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
        
        <!-- Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§Ø²ÛŒ -->
        <div id="ui">
            <div class="ui-panel">
                <div id="healthBar">
                    <div id="healthFill"></div>
                </div>
                <div id="ammoCounter">ğŸ”« Ù…Ù‡Ù…Ø§Øª: 1000</div>
                <div id="speedIndicator">ğŸš„ Ø³Ø±Ø¹Øª: 0 Ú©ÛŒÙ„ÙˆÙ…ØªØ±</div>
                <div id="scoreDisplay">â­ Ø§Ù…ØªÛŒØ§Ø²: 0</div>
                <div id="levelDisplay">ğŸ¯ Ù…Ø±Ø­Ù„Ù‡: 1</div>
            </div>
        </div>
        
        <!-- ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹ -->
        <div id="startScreen">
            <h1 class="title">Ù‚Ø·Ø§Ø± Ø¬Ù†Ú¯ÛŒ Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ</h1>
            <p class="subtitle">Ø³ÙØ± Ø³ÛŒÙ†Ù…Ø§ÛŒÛŒ Ø¨Ø§ Ú¯Ø±Ø§ÙÛŒÚ© ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡ â€¢ Ù…Ø¨Ø§Ø±Ø²Ù‡ Ø¨Ø§ Û²Û°Û° Ù†ÙˆØ¹ Ø¯Ø´Ù…Ù† â€¢ Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÙˆØ¹ Ø´Ù‡Ø±ÛŒØŒ Ø¨ÛŒØ§Ø¨Ø§Ù†ÛŒ Ùˆ Ø¯Ø±ÛŒØ§ÛŒÛŒ</p>
            <div class="features">
                <div class="feature">ğŸ® Ú©Ù†ØªØ±Ù„ Ø¢Ø³Ø§Ù†</div>
                <div class="feature">ğŸš Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ù‡Ù¾Ø§Ø¯</div>
                <div class="feature">ğŸ’¥ Ú¯Ø±Ø§ÙÛŒÚ© Ø³ÛŒÙ†Ù…Ø§ÛŒÛŒ</div>
                <div class="feature">ğŸ“± Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
            </div>
            <button id="startButton">Ø´Ø±ÙˆØ¹ Ù…Ø§Ø¬Ø±Ø§Ø¬ÙˆÛŒÛŒ</button>
        </div>

        <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
        <div class="mobile-controls">
            <div class="control-btn" id="accelerateBtn">ğŸš„</div>
            <div class="control-btn" id="fireBtn">ğŸ”«</div>
            <div class="control-btn" id="brakeBtn">ğŸ›‘</div>
            <div class="control-btn" id="cameraBtn">ğŸ“·</div>
        </div>

        <!-- Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒÙ†Ù…Ø§ÛŒÛŒ -->
        <div class="cinematic-bars"></div>
        <div class="film-effect"></div>
    </div>

    <!-- Ø³ÛŒØ³ØªÙ… Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ -->
    <script>
        // Ø³ÛŒØ³ØªÙ… Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡
        class GameLoader {
            constructor() {
                this.scripts = [
                    'js/main.js',
                    'js/train3d.js', 
                    'js/enemies.js',
                    'js/environment.js',
                    'js/camera.js'
                ];
                this.loadedCount = 0;
                this.totalScripts = this.scripts.length;
                this.game = null;
            }

            async loadGame() {
                try {
                    this.updateLoadingText('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØªÙˆØ± Ø¨Ø§Ø²ÛŒ...');
                    
                    // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§
                    for (const script of this.scripts) {
                        await this.loadScript(script);
                    }
                    
                    // Ù…Ù†ØªØ¸Ø± Ù…Ø§Ù†Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ DOM
                    await this.waitForDOM();
                    
                    // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ
                    this.initializeGame();
                    
                } catch (error) {
                    this.handleLoadingError(error);
                }
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    this.updateLoadingText(`Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${src.split('/').pop()}`);
                    
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        this.loadedCount++;
                        this.updateProgress();
                        resolve();
                    };
                    script.onerror = () => reject(new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${src}`));
                    document.head.appendChild(script);
                });
            }

            waitForDOM() {
                return new Promise(resolve => {
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', resolve);
                    } else {
                        resolve();
                    }
                });
            }

            initializeGame() {
                this.updateLoadingText('Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ...');
                
                setTimeout(() => {
                    try {
                        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯
                        document.getElementById('loadingScreen').style.display = 'none';
                        
                        // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹
                        document.getElementById('startScreen').style.display = 'flex';
                        
                        console.log('ğŸ® ØªÙ…Ø§Ù… Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ÙˆØ¯ Ø´Ø¯Ù†Ø¯!');
                        console.log('ğŸš‚ Ø¢Ù…Ø§Ø¯Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ...');
                        
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ:', error);
                        this.handleLoadingError(error);
                    }
                }, 1000);
            }

            updateLoadingText(text) {
                const loadingText = document.getElementById('loadingText');
                if (loadingText) {
                    loadingText.textContent = text;
                }
                console.log(`ğŸ“¦ ${text}`);
            }

            updateProgress() {
                const progress = (this.loadedCount / this.totalScripts) * 100;
                const progressBar = document.getElementById('loadingProgress');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
            }

            handleLoadingError(error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ø¨Ø§Ø²ÛŒ:', error);
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div class="title">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>
                        <div class="loading-text">${error.message}</div>
                        <button onclick="location.reload()" style="
                            padding: 10px 20px;
                            margin-top: 20px;
                            background: #ff6b35;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>
                    `;
                }
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù„ÙˆØ¯Ø± ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ù„ÙˆØ¯ Ø´Ø¯
        window.addEventListener('load', () => {
            const loader = new GameLoader();
            loader.loadGame();
        });

        // Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
        document.addEventListener('DOMContentLoaded', () => {
            const startButton = document.getElementById('startButton');
            if (startButton) {
                startButton.addEventListener('click', () => {
                    document.getElementById('startScreen').style.display = 'none';
                    startGame();
                });
            }

            // Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
            setupMobileControls();
        });

        // Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø§ØµÙ„ÛŒ
        function startGame() {
            try {
                console.log('ğŸ¯ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ...');
                
                // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
                if (typeof TrainCombatGame !== 'undefined') {
                    window.game = new TrainCombatGame();
                    
                    // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ù†Ø¯
                    if (typeof Train3D !== 'undefined') {
                        window.train3D = new Train3D(window.game);
                    }
                    if (typeof EnemySystem !== 'undefined') {
                        window.enemySystem = new EnemySystem(window.game);
                    }
                    if (typeof EnvironmentSystem !== 'undefined') {
                        window.environmentSystem = new EnvironmentSystem(window.game);
                    }
                    if (typeof CinematicCameraSystem !== 'undefined') {
                        window.cameraSystem = new CinematicCameraSystem(window.game);
                    }
                    
                    console.log('âœ… ØªÙ…Ø§Ù… Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯Ù†Ø¯!');
                    
                } else {
                    throw new Error('Ú©Ù„Ø§Ø³ TrainCombatGame Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ: ' + error.message);
            }
        }

        // ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
        function setupMobileControls() {
            const accelerateBtn = document.getElementById('accelerateBtn');
            const fireBtn = document.getElementById('fireBtn');
            const brakeBtn = document.getElementById('brakeBtn');
            const cameraBtn = document.getElementById('cameraBtn');

            if (accelerateBtn) {
                accelerateBtn.addEventListener('touchstart', () => {
                    if (window.game) window.game.accelerateTrain();
                });
            }

            if (fireBtn) {
                let fireInterval;
                fireBtn.addEventListener('touchstart', () => {
                    if (window.game) {
                        window.game.startFiring();
                        fireInterval = setInterval(() => {
                            if (window.game) window.game.startFiring();
                        }, 100);
                    }
                });
                fireBtn.addEventListener('touchend', () => {
                    if (window.game) window.game.stopFiring();
                    clearInterval(fireInterval);
                });
            }

            if (brakeBtn) {
                brakeBtn.addEventListener('touchstart', () => {
                    if (window.game) window.game.decelerateTrain();
                });
            }

            if (cameraBtn) {
                cameraBtn.addEventListener('touchstart', () => {
                    if (window.cameraSystem) window.cameraSystem.switchCamera();
                });
            }
        }

        // Ù‡Ù†Ø¯Ù„ Ø®Ø·Ø§Ù‡Ø§ÛŒå…¨å±€
        window.addEventListener('error', (event) => {
            console.error('ğŸš¨ Ø®Ø·Ø§ÛŒå…¨å±€:', event.error);
        });

        // Ù‡Ù†Ø¯Ù„ Ø±ÛŒØ²Ø§ÛŒØ² Ù¾Ù†Ø¬Ø±Ù‡
        window.addEventListener('resize', () => {
            if (window.game && window.game.handleResize) {
                window.game.handleResize();
            }
        });
    </script>
</body>
</html>
